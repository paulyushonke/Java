<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSRF Meta Tags -->
  <meta name="_csrf" th:content="${_csrf?.token}"/>
  <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

  <title th:text="'Appointments of ' + ${patient.name} + ' ' + ${patient.surname}">Appointments</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="flex flex-col items-center justify-center p-4 space-y-4">
  <div class="pt-6 text-3xl font-semibold" th:text="'Appointments of ' + ${patient.name} + ' ' + ${patient.surname}">Appointments</div>

  <div class="w-full max-w-6xl bg-white rounded-lg shadow-lg overflow-hidden">
    <div class="p-6 w-full">
      <div class="overflow-x-auto w-full">
        <table id="appointmentsTable" class="w-full text-sm text-left text-gray-500">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 cursor-pointer">Id</th>
            <th scope="col" class="px-6 py-3 cursor-pointer">Doctor Code</th>
            <th scope="col" class="px-6 py-3 cursor-pointer">Service Description</th>
            <th scope="col" class="px-6 py-3 cursor-pointer">Time of Visit</th>
            <th scope="col" class="px-6 py-3 cursor-pointer">Cost</th>
            <th scope="col" class="px-6 py-3 cursor-pointer">Payment</th>
            <th scope="col" class="px-6 py-3 cursor-pointer">Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="visit : ${appointments}" class="bg-white border-b hover:bg-gray-50" th:data-id="${visit.id}">
            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap" th:text="${visit.id}"></td>
            <td class="px-6 py-4" th:text="${visit.doctorCode}"></td>
            <td class="px-6 py-4" th:text="${visit.servant}"></td>
            <td class="px-6 py-4" th:text="${#temporals.format(visit.timeVisit, 'yyyy-MM-dd HH:mm')}"></td>
            <td class="px-6 py-4" th:text="${visit.cost}"></td>
            <td class="px-6 py-4" th:text="${visit.payment}"></td>
            <td class="px-6 py-4 text-center">
              <div class="relative inline-block text-left">
                <button class="inline-flex items-center justify-center w-8 h-8 text-gray-600 hover:text-gray-900 focus:outline-none">
                  <svg width="20" height="20" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.625 2.5C8.625 3.12132 8.12132 3.625 7.5 3.625C6.87868 3.625 6.375 3.12132 6.375 2.5C6.375 1.87868 6.87868 1.375 7.5 1.375C8.12132 1.375 8.625 1.87868 8.625 2.5ZM8.625 7.5C8.625 8.12132 8.12132 8.625 7.5 8.625C6.87868 8.625 6.375 8.12132 6.375 7.5C6.375 6.87868 6.87868 6.375 7.5 6.375C8.12132 6.375 8.625 6.87868 8.625 7.5ZM7.5 13.625C8.12132 13.625 8.625 13.1213 8.625 12.5C8.625 11.8787 8.12132 11.375 7.5 11.375C6.87868 11.375 6.375 11.8787 6.375 12.5C6.375 13.1213 6.87868 13.625 7.5 13.625Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path>
                  </svg>
                </button>
                <!-- Updated dropdown positioning -->
                <div th:id="'dropdown-appointment-' + ${visit.id}"
                     class="hidden absolute right-0 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-[9999] transform transition-all duration-100 ease-in-out"
                     style="position: fixed;">  <!-- Added fixed positioning -->
                  <div class="py-1">
                    <a th:href="@{/visits/update/{id}(id=${visit.id})}"
                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Update</a>
                    <a href="#"
                       th:onclick="'deleteAppointment(' + ${visit.id} + ', event)'"
                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Delete</a>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- No Results Message -->
  <div id="noResults" class="hidden text-center p-4 text-gray-500">
    No appointments found.
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="hidden fixed bottom-4 right-4 z-[9999]">
    <div class="bg-white rounded-lg border border-gray-200 w-72 shadow-lg" role="alert">
      <div class="flex p-4">
        <div class="flex-shrink-0">
          <svg class="h-4 w-4 text-green-500 mt-0.5" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="ml-3 w-0 flex-1 pt-0.5">
          <p id="toastMessage" class="text-sm font-medium text-gray-900"></p>
        </div>
        <div class="ml-4 flex-shrink-0 flex">
          <button type="button" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            <span class="sr-only">Close</span>
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Dialog -->
  <div id="confirmDialog" class="hidden fixed inset-0 overflow-y-auto z-[9999]">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
              <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
              <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                Delete Appointment
              </h3>
              <div class="mt-2">
                <p class="text-sm text-gray-500">
                  Are you sure you want to delete this appointment? This action cannot be undone.
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" id="confirmDeleteAppointment" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
            Delete
          </button>
          <button type="button" id="cancelDeleteAppointment" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  const contextPath = /*[[@{/}]]*/ '';
  let appointmentToDelete = null;

  function confirmDeleteAppointment() {
    if (appointmentToDelete) {
      const csrf = document.querySelector("meta[name='_csrf']").content;
      const csrfHeader = document.querySelector("meta[name='_csrf_header']").content;

      fetch(`${contextPath}visits/delete/${appointmentToDelete}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          [csrfHeader]: csrf
        }
      })
              .then(response => {
                if (response.ok) {
                  const row = document.querySelector(`tr[data-id="${appointmentToDelete}"]`);
                  if (row) {
                    row.remove();
                    showToast('Appointment deleted successfully', 'success');
                    if (document.querySelectorAll('#appointmentsTable tbody tr').length === 0) {
                      document.getElementById('noResults').classList.remove('hidden');
                    }
                  }
                } else {
                  return response.json().then(data => {
                    throw new Error(data.message || 'Failed to delete appointment');
                  });
                }
              })
              .catch(error => {
                showToast(error.message, 'error');
              })
              .finally(() => {
                hideConfirmDialog();
                appointmentToDelete = null;
              });
    }
  }

  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.textContent = message;

    if (type === 'success') {
      toast.querySelector('div').classList.remove('border-red-500');
      toast.querySelector('div').classList.add('border-green-500');
    } else if (type === 'error') {
      toast.querySelector('div').classList.remove('border-green-500');
      toast.querySelector('div').classList.add('border-red-500');
    }

    toast.classList.remove('hidden');

    setTimeout(() => {
      toast.classList.add('hidden');
    }, 3000);
  }

  function showConfirmDialog() {
    document.getElementById('confirmDialog').classList.remove('hidden');
  }

  function hideConfirmDialog() {
    document.getElementById('confirmDialog').classList.add('hidden');
  }

  function closeAllDropdowns() {
    document.querySelectorAll('[id^="dropdown-appointment-"]').forEach(dropdown => {
      dropdown.classList.add('hidden');
    });
  }

  function deleteAppointment(id, event) {
    event.preventDefault();
    appointmentToDelete = id;
    showConfirmDialog();
    closeAllDropdowns();
  }

  document.addEventListener('DOMContentLoaded', function() {
    const dropdownButtons = document.querySelectorAll('.relative.inline-block button');

    dropdownButtons.forEach(button => {
      button.addEventListener('click', function(event) {
        event.stopPropagation();
        const dropdown = this.nextElementSibling;
        const isVisible = !dropdown.classList.contains('hidden');

        // Close all other dropdowns first
        closeAllDropdowns();

        // Toggle current dropdown
        if (isVisible) {
          dropdown.classList.add('hidden');
        } else {
          // Get button position
          const buttonRect = button.getBoundingClientRect();
          const windowHeight = window.innerHeight;

          // Show dropdown
          dropdown.classList.remove('hidden');

          // Calculate dropdown height
          const dropdownHeight = dropdown.offsetHeight;

          // Position dropdown
          if (windowHeight - buttonRect.bottom > dropdownHeight + 10) {
            // Enough space below - show dropdown below
            dropdown.style.top = `${buttonRect.bottom + window.scrollY}px`;
            dropdown.style.bottom = 'auto';
          } else {
            // Not enough space below - show dropdown above
            dropdown.style.bottom = `${windowHeight - buttonRect.top + window.scrollY}px`;
            dropdown.style.top = 'auto';
          }

          // Position horizontally
          dropdown.style.left = `${buttonRect.right - dropdown.offsetWidth}px`;
        }
      });
    });

    // Delete button handlers
    const deleteLinks = document.querySelectorAll('[onclick*="deleteAppointment"]');
    deleteLinks.forEach(link => {
      link.addEventListener('click', function(event) {
        event.preventDefault();
        const tr = this.closest('tr');
        appointmentToDelete = tr.getAttribute('data-id');
        showConfirmDialog();
        closeAllDropdowns();
      });
    });

    // Confirmation dialog buttons
    document.getElementById('confirmDeleteAppointment')
            .addEventListener('click', confirmDeleteAppointment);
    document.getElementById('cancelDeleteAppointment')
            .addEventListener('click', hideConfirmDialog);

    // Toast close button
    document.querySelector('#toast button').addEventListener('click', function() {
      document.getElementById('toast').classList.add('hidden');
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.relative.inline-block')) {
        closeAllDropdowns();
      }
    });

    // Close dropdowns when scrolling
    document.addEventListener('scroll', closeAllDropdowns);

    // Close dropdowns when pressing escape
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeAllDropdowns();
        hideConfirmDialog();
      }
    });
  });
  /*]]>*/
</script>

</body>
</html>